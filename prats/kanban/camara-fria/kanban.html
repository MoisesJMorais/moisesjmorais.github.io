<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Digital</title>
    <style>
        /* ------------------------------------- */
        /* VARI√ÅVEIS DE ALTURA PARA C√ÅLCULO */
        /* ------------------------------------- */
        :root {
            --footer-height: 40px; 
            --padding-vertical: 20px; 
        }

        /* ------------------------------------- */
        /* CSS: ESTRUTURA E LAYOUT GERAL */
        /* ------------------------------------- */
        body {
            font-family: Arial, sans-serif;
            background-color: #A9A9A9; 
            margin: 0;
            padding: 0; 
            transition: background-color 0.3s, color 0.3s;
            
            height: 100vh;
            display: flex; 
            flex-direction: column; 
            /* IMPEDE A BARRA DE ROLAGEM VERTICAL PRINCIPAL */
            overflow-y: hidden; 
            overflow-x: hidden; 
        }

        /* ------------------------------------- */
        /* HEADER (TOPO FIXO) */
        /* ------------------------------------- */
        .header-container { 
            background-color: #F8F8FF; 
            padding: 20px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; 
            box-sizing: border-box; 
            z-index: 100; 
        }
        
        /* Estilos de conte√∫do do Header (Omitido por brevidade) */
        .header-content { text-align: center; width: 100%; max-width: 1200px; }
        .title-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; flex-wrap: wrap; }
        .header-content h1 { color: #172b4d; margin: 0; transition: color 0.3s; }
        .header-content p { color: #5e6c84; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; transition: color 0.3s; }
        
        /* ALTERADO: Estilo do Bot√£o Resetar em LIGHT MODE (claro) */
        #reset-button, #dark-mode-toggle { 
            padding: 8px 12px; 
            font-size: 14px; 
            border-radius: 4px; 
            cursor: pointer; 
            border: none; 
            transition: background-color 0.3s, color 0.3s; 
        }
        
        /* NOVO ESTILO: Fundo claro, texto escuro */
        #reset-button { background-color: #f0f0f0; color: #343a40; border: 1px solid #ccc; }
        #reset-button:hover { background-color: #e0e0e0; } 
        
        #dark-mode-toggle { background-color: #f0f0f0; color: #343a40; border: 1px solid #ccc; }
        #dark-mode-toggle:hover { background-color: #e0e0e0; }
        
        /* Estilos da Barra de Progresso */
        .progress-bar-container { 
            width: 80%; 
            max-width: 600px; 
            background-color: #ddd; 
            border-radius: 5px; 
            overflow: hidden; 
            margin: 15px auto 5px auto; 
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); 
            position: relative; 
        }
        #progress-bar { 
            height: 25px; 
            width: 0%; 
            background-color: #009900; 
            transition: width 0.5s ease-in-out; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #progress-summary { 
            text-align: center; 
            font-weight: bold; 
            color: #172b4d; 
            margin-bottom: 15px; 
            font-size: 1.1em; 
            transition: color 0.3s; 
        }
        /* Ajuste para o texto dentro da barra */
        #progress-text { 
            line-height: 25px; 
            color: white; 
            font-weight: bold; 
            font-size: 0.9em; 
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); 
            /* Importante: Garante que o texto fique centralizado horizontalmente na barra */
            width: 100%; 
            text-align: center;
        }


        /* ------------------------------------- */
        /* CONTE√öDO PRINCIPAL (√ÅREA ROL√ÅVEL) */
        /* ------------------------------------- */
        .kanban-container {
            flex-grow: 1; 
            overflow-x: auto; 
            overflow-y: hidden; 

            display: flex;
            justify-content: space-between;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto; 
            
            /* Ajuste o padding superior com a vari√°vel */
            padding-top: var(--padding-vertical); 
            padding-left: 20px;
            padding-right: 20px;

            /* CORRE√á√ÉO APLICADA AQUI: Adiciona espa√ßamento inferior para compensar o rodap√© */
            padding-bottom: 90px; 
            
            height: 100%; 
        }

        .kanban-column {
            flex: 1;
            background-color: #ebecf0;
            border-radius: 5px;
            padding: 10px;
            min-width: 300px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
            
            /* ESSENCIAL PARA O FUNDO ACOMPANHAR OS CARDS E MANTER A ROLAGEM INDEPENDENTE */
            height: 100%; 
            overflow-y: auto; 
            
            /* ------------------------------------- */
            /* OCULTAR BARRAS DE ROLAGEM INTERNAS */
            /* ------------------------------------- */
            /* Para Firefox */
            scrollbar-width: none; 
        }

        /* Para Chrome, Safari e Edge (baseado em WebKit) */
        .kanban-column::-webkit-scrollbar {
            display: none;
            width: 0; 
            height: 0;
        }

        .column-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            text-align: center;
            border-bottom: 2px solid #ccc;
            color: #172b4d;
            transition: color 0.3s, border-color 0.3s;
        }
        
        /* ------------------------------------- */
        /* FOOTER (BASE FIXA) */
        /* ------------------------------------- */
        footer {
            height: var(--footer-height); 
            background-color: #F8F8FF;
            color: #5e6c84;
            text-align: center;
            padding: 10px 20px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05); 
            line-height: 20px;
            width: 100%;
            box-sizing: border-box;
            z-index: 100;
            font-size: 0.9em;
            flex-shrink: 0; 
            position: fixed; /* Garante que fique fixo na base */
            bottom: 0;
        }


        /* Estilos de Cards e Modal (Omitido por brevidade) */
        .card { 
            background-color: #fff; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 3px; 
            box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25); 
            cursor: pointer; /* Alterado para indicar clique */
            transition: background-color 0.3s ease, color 0.3s, border 0.2s; 
            position: relative; 
        }
        .card:hover { 
            background-color: #f4f5f7; 
            /* Efeito visual para indicar que pode ser clicado para descri√ß√£o */
            border-bottom: 2px solid #007bff; 
        }
        
        /* NOVO: √çcones de A√ß√£o no Card */
        .card-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px; /* Espa√ßo entre os √≠cones */
        }
        
        .card-delete-btn, .card-priority-btn { 
            color: #5e6c84; 
            font-weight: bold; 
            cursor: pointer; 
            padding: 0 5px; 
            border-radius: 3px; 
            line-height: 1; 
            transition: color 0.2s, background-color 0.2s; 
            font-size: 1.2em; /* Tamanho maior para a estrela/x */
        }
        .card-delete-btn:hover { color: #cc0000; }
        
        /* Estilos da Estrela de Prioridade */
        .card-priority-btn {
            color: #ccc; /* Estrela n√£o priorit√°ria (cinza) */
        }
        .card-priority-btn.active {
            color: #ffc107; /* Estrela priorit√°ria (amarela) */
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.5); /* Leve brilho */
        }
        .card-priority-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .card:active { opacity: 0.8; transform: scale(1.02); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); cursor: grabbing; }
        .card-placeholder { opacity: 0.2; background-color: #5e6c84; height: 46px; margin-bottom: 10px; border-radius: 3px; }
        .kanban-column.drag-over { background-color: #dadbdd; }
        
        /* ------------------------------------- */
        /* CORES DOS CARDS LIGHT MODE (Mais Escuras/Saturadas) */
        /* ------------------------------------- */
        .card-red { background-color: #ffcdd2; border-left: 5px solid #cc0000; }
        .card-yellow { background-color: #fff9c4; border-left: 5px solid #cccc00; }
        .card-green { background-color: #c8e6c9; border-left: 5px solid #009900; }
        
        .card-content { display: block; min-height: 18px; padding: 0; margin-right: 40px; cursor: text; }
        .card-content[contenteditable="true"] { outline: none; padding: 2px 4px; border-radius: 3px; background-color: transparent; }
        .add-card-area { text-align: center; padding: 5px; cursor: pointer; color: #5e6c84; border-top: 1px dashed #ccc; margin-top: 10px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .add-card-area:hover { background-color: #e3e4e7; }
        .add-card-area input { width: 90%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* MODAL DE CONFIRMA√á√ÉO ESTILIZADO (Usado para Confirma√ß√£o E Edi√ß√£o de Descri√ß√£o) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-content { 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
            max-width: 500px; /* Aumentado para melhor visualiza√ß√£o da descri√ß√£o */
            width: 90%; 
            text-align: left; /* Alinhamento para edi√ß√£o de texto */
            transition: background-color 0.3s, color 0.3; 
        }
        .modal-content h3 { margin-top: 0; color: #172b4d; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        .modal-button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .modal-confirm-btn { background-color: #007bff; color: white; }
        .modal-confirm-btn:hover { background-color: #0056b3; }
        .modal-cancel-btn { background-color: #f0f0f0; color: #343a40; border: 1px solid #ccc; }
        .modal-cancel-btn:hover { background-color: #e0e0e0; }

        /* NOVO: Estilo para a √Årea de Descri√ß√£o no Modal */
        #description-input-area {
            width: 100%;
            margin-top: 10px;
        }
        #description-textarea {
            width: 96%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }
        #description-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #172b4d;
        }

        /* DARK MODE ESTILOS (MANTIDOS) */
        body.dark-mode { background-color: #121212; color: #f4f7f9; }
        body.dark-mode .header-container { background-color: #000000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        body.dark-mode .header-content h1 { color: #ffffff; }
        body.dark-mode .header-content p { color: #b3bac5; }
        body.dark-mode footer { background-color: #000000; color: #b3bac5; box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3); }
        body.dark-mode .column-header { color: #ffffff; border-bottom: 2px solid #555; }
        body.dark-mode .kanban-column { background-color: #1e1e1e; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.15); }
        body.dark-mode .card { background-color: #2a2a2a; color: #ffffff; box-shadow: 0 1px 0 rgba(255, 255, 255, 0.15); }
        body.dark-mode .card:hover { background-color: #333333; }
        body.dark-mode .card-delete-btn { color: #b3bac5; }
        body.dark-mode .kanban-column.drag-over { background-color: #3a3a3a; }
        body.dark-mode .card-red { background-color: #cc4444; border-left: 5px solid #ff1a1a; }
        body.dark-mode .card-yellow { background-color: #c9c937; border-left: 5px solid #e6e600; }
        body.dark-mode .card-green { background-color: #44cc44; border-left: 5px solid #1aff1a; }
        
        /* Estilo do Bot√£o Resetar em DARK MODE (escuro) */
        body.dark-mode #reset-button { background-color: #444; color: #ffffff; border: 1px solid #444; }
        body.dark-mode #reset-button:hover { background-color: #555; }
        
        body.dark-mode #dark-mode-toggle { background-color: #444; color: #ffffff; border: 1px solid #444; }
        body.dark-mode #dark-mode-toggle:hover { background-color: #555; }
        body.dark-mode .add-card-area { color: #b3bac5; border-top: 1px dashed #555; }
        body.dark-mode .add-card-area:hover { background-color: #2a2a2a; }
        body.dark-mode .add-card-area input { background-color: #1e1e1e; color: #f4f7f9; border-color: #555; }
        body.dark-mode .progress-bar-container { background-color: #2a2a2a; }
        body.dark-mode #progress-summary { color: #f4f7f9; }
        body.dark-mode .modal-content { background-color: #2a2a2a; color: #f4f7f9; }
        body.dark-mode .modal-content h3 { color: #ffffff; }
        body.dark-mode .modal-cancel-btn { background-color: #444; color: #f4f7f9; border: 1px solid #555; }
        body.dark-mode .modal-cancel-btn:hover { background-color: #555; }
        body.dark-mode .modal-confirm-btn { background-color: #ff3333; }
        body.dark-mode .modal-confirm-btn:hover { background-color: #cc0000; }
        body.dark-mode #description-label { color: #f4f7f9; }
        body.dark-mode #description-textarea { 
            background-color: #1e1e1e; 
            color: #f4f7f9; 
            border: 1px solid #555; 
        }

        /* Estilo da estrela em Dark Mode */
        body.dark-mode .card-priority-btn {
            color: #555; 
        }
        body.dark-mode .card-priority-btn.active {
            color: #ffc107; 
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.7); 
        }

        
    </style>
</head>
<body class="light-mode">

    <div class="header-container">
        <div class="header-content">
            
            <div class="title-group">
                <h1>üìà Kanban - C√¢mara Fria</h1>
                <button id="dark-mode-toggle">üåô</button>
                <button id="reset-button">üîÑ</button>
            </div>

		<p>Simples ferramenta de Administra√ß√£o para maximizar a produtividade no setor</p>

            <div class="progress-bar-container">
                <div id="progress-bar">
                    <span id="progress-text"></span>
                </div>
            </div>
            
            <div id="progress-summary">0 de 0 tarefas conclu√≠das (0%)</div>

        </div>
    </div>

    <div class="kanban-container">
        <div class="kanban-column" id="to-do">
            <div class="column-header">üî¥ Pendente</div>
            <div class="add-card-area" onclick="showCardInput('to-do')">
                + Adicionar novo card
                <input type="text" onkeyup="checkEnter(event, 'to-do')" placeholder="Descri√ß√£o do Card" style="display:none;">
            </div>
        </div>

        <div class="kanban-column" id="in-progress">
            <div class="column-header">üü° Em Progresso</div>
            <div class="add-card-area" onclick="showCardInput('in-progress')">
                + Adicionar novo card
                <input type="text" onkeyup="checkEnter(event, 'in-progress')" placeholder="Descri√ß√£o do Card" style="display:none;">
            </div>
        </div>

        <div class="kanban-column" id="done">
            <div class="column-header">üü¢ Conclu√≠do</div>
            <div class="add-card-area" onclick="showCardInput('done')">
                + Adicionar novo card
                <input type="text" onkeyup="checkEnter(event, 'done')" placeholder="Descri√ß√£o do Card" style="display:none;">
            </div>
        </div>
    </div>

    <footer>
        Kanban - Gest√£o de Tarefas | Desenvolvido por Mois√©s J. Morais Lima
    </footer>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Confirma√ß√£o</h3>
            <p id="modal-message">Tem certeza de que deseja realizar esta a√ß√£o?</p>
            
            <div id="description-input-area" style="display:none;">
                <label id="description-label" for="description-textarea">Descri√ß√£o Detalhada:</label>
                <textarea id="description-textarea" placeholder="Adicione a descri√ß√£o do seu card aqui."></textarea>
            </div>

            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-button modal-cancel-btn">Cancelar</button>
                <button id="modal-confirm" class="modal-button modal-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        /* ------------------------------------- */
        /* JAVASCRIPT: L√≥gica de Persist√™ncia, Drag and Drop, Delete, Dark Mode, Progress Bar */
        /* ------------------------------------- */
        
        // Cards iniciais com novos campos: description e priority
        const initialCards = [
            { id: 'card1', content: 'Abertura de fluxo de estoque', status: 'to-do', description: 'Abrir o fluxo de movimenta√ß√£o de estoque durante o turno (FMEC).', priority: true },
            { id: 'card2', content: 'Lista de presen√ßa (DDS)', status: 'to-do', description: 'Coletar assinaturas da lista de presen√ßa do Di√°logo Di√°rio de Seguran√ßa (DDS).', priority: true }, // PRIORIT√ÅRIO
            { id: 'card3', content: 'Check-list de empilhadeiras', status: 'to-do', description: 'Preencher o check-list di√°rio de cada empilhadeira que for utilizada durante o turno e reportar eventuais problemas detectados durante a inspe√ß√£o.', priority: true },
            { id: 'card4', content: 'Ficha de limpeza', status: 'to-do', description: 'Preencher a ficha de controle de limpeza di√°ria da c√¢mara fria.', priority: true },
	{ id: 'card5', content: 'Lote do dia', status: 'to-do', description: 'Conferir nas embalagens envasadas o lote e data de hoje para evitar erros no processo e retrabalhos.', priority: true },
	{ id: 'card6', content: 'Reprocesso NFC', status: 'to-do', description: 'Verificar se tem reprocesso de NFC na c√¢mara fria do mesmo sabor que est√° sendo produzido no dia e comunicar o encarregado/supervisor de produ√ß√£o.', priority: true },
	{ id: 'card7', content: 'Descartes', status: 'to-do', description: 'Verificar se tem produto para ser descartado da c√¢mara fria e comunicar o encarregado/supervisor de produ√ß√£o.', priority: true },
	{ id: 'card8', content: 'Produ√ß√£o anterior', status: 'to-do', description: 'Conferir a produ√ß√£o do turno anterior para evitar poss√≠veis erros de apontamento.', priority: true },
	{ id: 'card9', content: 'FORM-PROD-015', status: 'to-do', description: 'Verificar se o formul√°rio FORM-PROD-015 (Controle de Entrada de Produto Acabado) est√° sendo devidamente preenchido pelos operadores de empilhadeira.', priority: true },
	{ id: 'card10', content: 'Mesa do computador', status: 'to-do', description: 'Manter a mesa do computador sempre organizada, sem objetos desnecess√°rios.', priority: false },
	{ id: 'card11', content: 'Arm√°rios de documentos e objetos', status: 'to-do', description: 'Manter os dois arm√°rios organizados.', priority: false },
	{ id: 'card12', content: 'Fichas de Produ√ß√£o', status: 'to-do', description: 'Verificar se tem uma quantidade razo√°vel de formul√°rios de produ√ß√£o impressos e prontos para uso.', priority: false },
	{ id: 'card13', content: 'Ordens de produ√ß√£o', status: 'to-do', description: 'Verificar quais linhas de produ√ß√£o v√£o operar durante o turno e j√° abrir as OPs caso ainda n√£o tiver abertas.', priority: false },
	{ id: 'card14', content: 'Lixos do setor', status: 'to-do', description: 'Trocar o saco de lixo das lixeiras do setor se estiverem cheias.', priority: false },
	{ id: 'card15', content: 'Pallets sem uso', status: 'to-do', description: 'Retirar do setor pallets quebrados ou vazios, mantendo o ambiente mais limpo e organizado.', priority: false },
	{ id: 'card16', content: 'Papel√£o sem uso', status: 'to-do', description: 'Retirar do setor chapas de papel√£o rasgadas, sujas ou sem uso, mantendo o ambiente mais limpo e organizado.', priority: false },
	{ id: 'card17', content: 'Conferir produ√ß√£o 17:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card18', content: 'Conferir produ√ß√£o 18:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card19', content: 'Conferir produ√ß√£o 19:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card20', content: 'Conferir produ√ß√£o 20:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card21', content: 'Conferir produ√ß√£o 21:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card22', content: 'Conferir produ√ß√£o 22:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
	{ id: 'card23', content: 'Conferir produ√ß√£o 23:00h', status: 'to-do', description: 'Confer√™ncia da produ√ß√£o armazenada na c√¢mara fria de hora em hora.', priority: false },
        ];

        const colorMap = {
            'to-do': 'card-red',
            'in-progress': 'card-yellow',
            'done': 'card-green'
        };

        let currentCards = []; 
        let draggedCard = null; 
        let placeholder = null; 
        let isEditing = false;
        
        // Elementos do Modal
        const modalOverlay = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        
        // Elementos de Descri√ß√£o
        const descriptionArea = document.getElementById('description-input-area');
        const descriptionTextarea = document.getElementById('description-textarea');
        let currentModalMode = 'confirmation'; // 'confirmation' ou 'description'
        let currentCardId = null;

        // Fun√ß√£o para alternar o conte√∫do do Modal
        function setModalContent(mode, title, message, showDescriptionArea, confirmText, cancelText) {
            currentModalMode = mode;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            descriptionArea.style.display = showDescriptionArea ? 'block' : 'none';
            modalMessage.style.display = showDescriptionArea ? 'none' : 'block';
            
            modalConfirmBtn.textContent = confirmText || 'Confirmar';
            modalCancelBtn.textContent = cancelText || 'Cancelar';

            modalOverlay.style.display = 'flex'; 
        }


        // Fun√ß√£o para exibir o Modal de Confirma√ß√£o
        function showConfirmationModal(message, confirmText, cancelText) {
            return new Promise(resolve => {
                setModalContent('confirmation', 'Confirma√ß√£o', message, false, confirmText, cancelText);
                
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    modalOverlay.style.display = 'none'; 
                };

                // Limpa ouvintes anteriores para evitar m√∫ltiplas execu√ß√µes
                modalConfirmBtn.onclick = handleConfirm;
                modalCancelBtn.onclick = handleCancel;
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        handleCancel();
                    }
                };
            });
        }
        
        // NOVO: Fun√ß√£o para exibir o Modal de Edi√ß√£o de Descri√ß√£o
        function showDescriptionModal(cardId, initialDescription) {
            currentCardId = cardId;
            return new Promise(resolve => {
                setModalContent('description', 'Editar Descri√ß√£o do Card', '', true, 'Salvar', 'Fechar');
                descriptionTextarea.value = initialDescription || '';
                
                const handleSave = () => {
                    const newDescription = descriptionTextarea.value;
                    cleanup();
                    resolve({ saved: true, description: newDescription });
                };

                const handleCancel = () => {
                    cleanup();
                    resolve({ saved: false });
                };

                const cleanup = () => {
                    modalConfirmBtn.removeEventListener('click', handleSave);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    modalOverlay.style.display = 'none'; 
                    currentCardId = null;
                };

                modalConfirmBtn.onclick = handleSave;
                modalCancelBtn.onclick = handleCancel;
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        handleCancel();
                    }
                };
            });
        }
        
        // 1. Fun√ß√µes de Persist√™ncia
        
        function loadCards() {
            const savedCards = localStorage.getItem('kanbanCards');
            if (savedCards) {
                currentCards = JSON.parse(savedCards);
            } else {
                // Ao carregar pela primeira vez, garante que a lista inicial tenha os novos campos
                currentCards = initialCards.map(card => ({
                    ...card,
                    description: card.description || '', 
                    priority: card.priority || false
                }));
                saveCards();
            }
            renderCards();
            updateProgressBar();
        }

        function saveCards() {
            localStorage.setItem('kanbanCards', JSON.stringify(currentCards));
        }
        
        // 2. Cria√ß√£o e Renderiza√ß√£o dos Cards

        function createCardElement(cardData) {
            const card = document.createElement('div');
            card.className = `card ${colorMap[cardData.status]}`;
            card.id = cardData.id;
            card.draggable = true;
            
            // Evento para abrir o modal de descri√ß√£o
            card.addEventListener('click', (e) => {
                // Garante que o clique n√£o foi no bot√£o de delete ou priority, nem na edi√ß√£o do t√≠tulo
                if (e.target.classList.contains('card-content')) return;
                if (e.target.closest('.card-actions')) return;
                
                openCardDescription(cardData.id);
            });
            
            const content = document.createElement('span');
            content.className = 'card-content';
            content.textContent = cardData.content;
            content.setAttribute('contenteditable', 'true');
            
            content.addEventListener('blur', (e) => saveCardContent(cardData.id, e.target.textContent));
            content.addEventListener('focus', () => isEditing = true);
            content.addEventListener('blur', () => isEditing = false);
            
            card.appendChild(content);

            // NOVO: Container para os bot√µes de a√ß√£o (prioridade e exclus√£o)
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'card-actions';

            // NOVO: Bot√£o de Prioridade (Estrela)
            const priorityBtn = document.createElement('span');
            priorityBtn.className = 'card-priority-btn';
            priorityBtn.innerHTML = '&#9733;'; // S√≠mbolo da estrela (cheio)
            if (cardData.priority) {
                priorityBtn.classList.add('active');
            }
            priorityBtn.onclick = (e) => {
                e.stopPropagation();
                toggleCardPriority(cardData.id);
            };
            actionsContainer.appendChild(priorityBtn);


            // Bot√£o de Exclus√£o
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'card-delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await showConfirmationModal(
                    'Deseja realmente remover este cart√£o de forma permanente?', 
                    'Excluir',
                    'Cancelar'
                );
                if (confirmed) {
                    deleteCard(cardData.id);
                }
            };
            actionsContainer.appendChild(deleteBtn);
            
            card.appendChild(actionsContainer);
            
            card.addEventListener('dragstart', dragStart);
            card.addEventListener('dragend', dragEnd);
            
            return card;
        }

        function renderCards() {
            // Limpa o conte√∫do das colunas
            document.querySelectorAll('.kanban-column').forEach(col => {
                Array.from(col.children).forEach(child => {
                    if (child.classList.contains('card') || child.classList.contains('card-placeholder')) {
                        col.removeChild(child);
                    }
                });
            });

            const columnElements = {
                'to-do': document.getElementById('to-do'),
                'in-progress': document.getElementById('in-progress'),
                'done': document.getElementById('done')
            };
            
            // Ordenar cards: priorit√°rios primeiro, depois pela ordem de cria√ß√£o
            const sortedCards = [...currentCards].sort((a, b) => {
                if (a.priority && !b.priority) return -1;
                if (!a.priority && b.priority) return 1;
                // Se a prioridade for igual, mant√©m a ordem original (pelo ID ou ordem de inser√ß√£o)
                return 0;
            });


            sortedCards.forEach(cardData => {
                const column = columnElements[cardData.status];
                if (column) {
                    const cardElement = createCardElement(cardData);
                    const addArea = column.querySelector('.add-card-area');
                    // Inserir o novo card antes da √°rea de adicionar novo
                    column.insertBefore(cardElement, addArea);
                }
            });
        }
        
        // 3. L√≥gica de Drag and Drop (Mantida)
        function dragStart(e) {
            if (isEditing || e.target.closest('.card-actions') || e.target.classList.contains('card-content')) {
                e.preventDefault();
                return;
            }
            draggedCard = e.target.closest('.card');
            if (!draggedCard) return;

            e.dataTransfer.setData('text/plain', draggedCard.id);
            e.dataTransfer.effectAllowed = 'move';
            
            placeholder = document.createElement('div');
            placeholder.className = 'card-placeholder';
            placeholder.style.height = `${draggedCard.offsetHeight}px`; 
            
            setTimeout(() => {
                if (draggedCard.parentNode) {
                    draggedCard.parentNode.insertBefore(placeholder, draggedCard);
                    draggedCard.style.display = 'none';
                }
            }, 0);
        }
        
        function dragEnd(e) {
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }
            if (draggedCard) {
                draggedCard.style.display = 'block';
            }
            
            draggedCard = null;
            placeholder = null;
            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
            
            // Reordenar cards com base na nova posi√ß√£o
            const orderedCards = [];
            document.querySelectorAll('.kanban-container .kanban-column').forEach(col => {
                const columnId = col.id;
                Array.from(col.querySelectorAll('.card')).forEach(cardElement => {
                    const cardDataFound = currentCards.find(c => c.id === cardElement.id);
                    if (cardDataFound) {
                        cardDataFound.status = columnId;
                        orderedCards.push(cardDataFound);
                    }
                });
            });
            currentCards = orderedCards; 
            
            saveCards();
            // Chamada extra para garantir que a prioridade se mantenha no topo
            renderCards(); 
        }

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const targetColumn = e.currentTarget;
            
            if (!targetColumn.classList.contains('drag-over')) {
                targetColumn.classList.add('drag-over');
            }
            
            if (draggedCard && placeholder) {
                const afterElement = getDragAfterElement(targetColumn, e.clientY);
                
                if (afterElement == null) {
                    const addArea = targetColumn.querySelector('.add-card-area');
                    targetColumn.insertBefore(placeholder, addArea);
                } else {
                    targetColumn.insertBefore(placeholder, afterElement);
                }
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = Array.from(container.querySelectorAll('.card:not([style*="display: none"]), .card-placeholder'))
                .filter(element => element !== draggedCard);

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: -Infinity }).element;
        }


        function dragLeave(e) {
             e.currentTarget.classList.remove('drag-over');
        }

        function drop(e) {
            e.preventDefault();
            const targetColumn = e.currentTarget;
            targetColumn.classList.remove('drag-over');
            
            if (draggedCard) {
                const cardId = draggedCard.id;
                const cardData = currentCards.find(c => c.id === cardId);
                const oldStatus = cardData ? cardData.status : null;
                const newStatus = targetColumn.id;
                
                if (placeholder && placeholder.parentNode) {
                    targetColumn.insertBefore(draggedCard, placeholder);
                } else {
                    const addArea = targetColumn.querySelector('.add-card-area');
                    targetColumn.insertBefore(draggedCard, addArea);
                }
                
                draggedCard.style.display = 'block';
                
                if (oldStatus && oldStatus !== newStatus) {
                    draggedCard.classList.remove(colorMap[oldStatus]);
                    const newColorClass = colorMap[newStatus];
                    draggedCard.classList.add(newColorClass);
                }
                
                const orderedCards = [];
                document.querySelectorAll('.kanban-container .kanban-column').forEach(col => {
                    const columnId = col.id;
                    Array.from(col.querySelectorAll('.card')).forEach(cardElement => {
                        const cardDataFound = currentCards.find(c => c.id === cardElement.id);
                        if (cardDataFound) {
                            cardDataFound.status = columnId;
                            orderedCards.push(cardDataFound);
                        }
                    });
                });
                
                currentCards = orderedCards;
                saveCards();
                updateProgressBar();
            }
            renderCards(); 
        }

        // 4. L√≥gica de Edi√ß√£o de Card
        
        function saveCardContent(cardId, newContent) {
            const card = currentCards.find(c => c.id === cardId);
            if (card) {
                card.content = newContent.trim();
                saveCards();
            }
        }
        
        // NOVO: L√≥gica de Prioriza√ß√£o
        function toggleCardPriority(cardId) {
            const card = currentCards.find(c => c.id === cardId);
            if (card) {
                card.priority = !card.priority;
                saveCards();
                renderCards(); // Re-renderiza para colocar o priorit√°rio no topo
            }
        }

        // NOVO: Abrir e Salvar Descri√ß√£o
        async function openCardDescription(cardId) {
            const cardData = currentCards.find(c => c.id === cardId);
            if (!cardData) return;

            const result = await showDescriptionModal(cardId, cardData.description);
            
            if (result.saved) {
                cardData.description = result.description;
                saveCards();
            }
        }
        
        // 5. L√≥gica de Exclus√£o de Card
        
        function deleteCard(cardId) {
            currentCards = currentCards.filter(card => card.id !== cardId);
            saveCards();
            renderCards();
            updateProgressBar();
        }
        
        // 6. L√≥gica do Bot√£o Reset (REINICIA PARA OS CARDS INICIAIS)
        
        document.getElementById('reset-button').addEventListener('click', async () => {
            const confirmed = await showConfirmationModal(
                "Deseja realmente apagar todos os cards atuais e reiniciar o painel para o estado inicial?", 
                'Reiniciar',
                'Cancelar'
            );
            
            if (confirmed) {
                // Copia profunda (deep copy) da lista inicial, incluindo os novos campos
                currentCards = initialCards.map(card => ({
                    ...card,
                    description: card.description || '', 
                    priority: card.priority || false
                }));
                saveCards();
                renderCards();
                updateProgressBar();
            }
        });
        
        // 7. L√≥gica de Adicionar Novo Card
        function getNextCardId() {
            let maxIdNum = 0;
            currentCards.forEach(card => {
                const match = card.id.match(/card(\d+)/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxIdNum) {
                        maxIdNum = num;
                    }
                }
            });
            return `card${maxIdNum + 1}`;
        }
        
        function addNewCard(columnId, content) {
            if (content.trim() === "") return;

            const newCard = {
                id: getNextCardId(),
                content: content.trim(),
                status: columnId,
                // NOVOS CAMPOS PADR√ÉO
                description: '', 
                priority: false 
            };

            currentCards.push(newCard);
            saveCards();
            renderCards(); 
            updateProgressBar();
        }

        function showCardInput(columnId) {
            const column = document.getElementById(columnId);
            const input = column.querySelector('.add-card-area input');
            const area = column.querySelector('.add-card-area');
            
            document.querySelectorAll('.add-card-area input').forEach(inp => {
                if (inp !== input) {
                    inp.style.display = 'none';
                    const parentArea = inp.closest('.add-card-area');
                    if (parentArea) {
                        parentArea.onclick = () => showCardInput(parentArea.closest('.kanban-column').id);
                    }
                }
            });
            
            input.value = ''; 
            input.style.display = 'block';
            input.focus();
            
            area.onclick = () => input.focus();
        }
        
        function checkEnter(event, columnId) {
            if (event.key === 'Enter') {
                const input = event.target;
                addNewCard(columnId, input.value);
                
                input.value = '';
                input.style.display = 'none';
                
                const area = input.closest('.add-card-area');
                area.onclick = () => showCardInput(columnId);
            }
        }
        
        // 8. L√≥gica Dark Mode (Mantida)
        const toggleButton = document.getElementById('dark-mode-toggle');
        
        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.body.classList.toggle('light-mode', !isDarkMode);
            toggleButton.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåë';
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            toggleButton.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåë';
        }

        toggleButton.addEventListener('click', toggleDarkMode);

        // 9. L√≥gica da Barra de Progresso (Mantida)
        function updateProgressBar() {
            const totalCards = currentCards.length;
            const doneCards = currentCards.filter(card => card.status === 'done').length;
            
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressSummary = document.getElementById('progress-summary');
            
            let percentage = 0;
            if (totalCards > 0) {
                percentage = Math.round((doneCards / totalCards) * 100);
            }
            
            progressBar.style.width = `${percentage}%`;
            
            if (percentage > 0) {
                progressText.textContent = `${percentage}%`;
            } else {
                progressText.textContent = ''; 
            }
            
            progressSummary.textContent = `${doneCards} de ${totalCards} tarefas conclu√≠das`;
        }
        
        // 10. Inicializa√ß√£o (Mantida)
        
        document.querySelectorAll('.kanban-column').forEach(column => {
            if (column.id !== 'to-do' && column.id !== 'in-progress' && column.id !== 'done') return;
            
            column.addEventListener('dragover', dragOver);
            column.addEventListener('dragleave', dragLeave);
            column.addEventListener('drop', drop);
        });

        window.onload = () => {
            loadCards();
            loadDarkModePreference();
        };

    </script>

</body>
</html>
