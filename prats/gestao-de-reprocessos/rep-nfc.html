<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>Desenvolvido por Mois√©s J. Morais Lima</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* BLOQUEIO MOBILE */
        .mobile-warning { display: none; }
        @media (max-width: 767px) {
            html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #ffffff; }
            .container { display: none !important; }
            .mobile-warning { 
                display: flex !important; flex-direction: column; align-items: center; justify-content: center; 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; 
                z-index: 999999; padding: 20px; box-sizing: border-box; text-align: center; font-family: 'Segoe UI', sans-serif;
            }
            .mobile-warning .icon { font-size: 64px; margin-bottom: 20px; }
            .mobile-warning h1 { color: #e74c3c; font-size: 26px; margin: 0 0 15px 0; }
        }

        /* ESTILOS DESKTOP */
        body { font-family: 'Segoe UI', sans-serif; background-color: #e9ecef; margin: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 85vh; display: flex; flex-direction: column; }
        .header-app { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; }
        .header-app h2 { color: #2c3e50; border-left: 5px solid #27ae60; padding-left: 15px; margin: 0; }
        .header-buttons { display: flex; gap: 8px; }
        .panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .grid-inputs { display: flex; gap: 10px; flex-wrap: wrap; }
        input, select, button { padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 13px; }
        
        #lote, #fLote { width: 110px; flex-shrink: 0; }
        
        button { cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-add { background-color: #27ae60; color: white; flex-grow: 1; }
        .btn-util { color: white; padding: 8px 15px; font-size: 11px; }
        .btn-json { background-color: #34495e; }
        .btn-pdf { background-color: #e74c3c; }
        .btn-import { background-color: #8e44ad; }
        .btn-tabela { font-size: 10px; padding: 5px 8px; background: #fff; border: 1px solid #ccc; color: #333; border-radius: 4px; }
        .btn-excluir { background-color: #e74c3c !important; color: white !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { background-color: #2d3748; color: white; padding: 12px; font-size: 12px; }
        td { padding: 8px; border-bottom: 1px solid #edf2f7; text-align: center; font-weight: 500; font-size: 13px; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: auto; padding-top: 20px; }
        .btn-page { background: #34495e; color: white; padding: 8px 15px; }

        .sabor-laranja { background-color: #ffe082 !important; }
        .sabor-fruitz-laranja { background-color: #ffc107 !important; }
        .sabor-uva { background-color: #d1c4e9 !important; }
        .sabor-fruitz-uva { background-color: #4a148c !important; color: white !important; }
        .sabor-acerola { background-color: #ff7043 !important; }
        .sabor-limao { background-color: #ccff90 !important; }
        .sabor-goiaba { background-color: #f48fb1 !important; }
        .sabor-caju { background-color: #e6ee9c !important; }

        .status-pendente { color: #d35400; font-weight: 800; background: white; padding: 4px; border-radius: 4px; }
        .status-reprocessado { color: #27ae60; font-weight: 800; background: white; padding: 4px; border-radius: 4px; }
        .status-descartado { color: #7f8c8d; font-weight: 800; background: white; padding: 4px; border-radius: 4px; }
        
        .filters-bar { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; background: #eee; padding: 10px; border-radius: 8px; }
        .filters-bar input, .filters-bar select { flex-grow: 1; }
    </style>
</head>
<body>
    <script src="security.js"></script>
    <div class="mobile-warning">
        <div class="icon">üñ•Ô∏è</div>
        <h1>Dispositivo m√≥vel incompat√≠vel...</h1>
    </div>

    <div class="container">
        <header class="header-app">
            <h2>GEST√ÉO DE REPROCESSOS | C√ÇMARA FRIA NFC</h2>
            <div class="header-buttons">
                <button class="btn-util btn-json" onclick="exportarJSON()">Backup JSON</button>
                <button class="btn-util btn-import" onclick="document.getElementById('fileInput').click()">Importar JSON</button>
                <button class="btn-util btn-pdf" onclick="exportarPDF()">Exportar PDF</button>
                <input type="file" id="fileInput" style="display:none" onchange="importarJSON(event)">
            </div>
        </header>
        
        <div class="panel">
            <div class="grid-inputs">
                <input type="text" id="lote" placeholder="Lote" maxlength="15">
                <select id="sku">
                    <option value="">SKU</option>
                    <option value="200 ML">200 ML</option><option value="300 ML">300 ML</option>
                    <option value="900 ML">900 ML</option><option value="1.5 LT">1.5 LT</option>
                    <option value="3 LT">3 LT</option><option value="5 LT">5 LT</option>
                </select>
                <select id="sabor">
                    <option value="">Sabor</option>
                    <option value="Laranja">Laranja</option><option value="Fruitz Laranja">Fruitz Laranja</option>
                    <option value="Uva">Uva</option><option value="Fruitz Uva">Fruitz Uva</option>
                    <option value="Acerola">Acerola</option><option value="Lim√£o">Lim√£o</option>
                    <option value="Goiaba">Goiaba</option><option value="Caju">Caju</option>
                </select>
                <input type="number" id="qtd" placeholder="Qtd">
                <select id="unidade">
                    <option value="Rep. Linha">Rep. Linha</option>
                    <option value="Prod. Acabado">Prod. Acabado</option>
                </select>
                <input type="date" id="validade" title="Data de Validade">
                <button class="btn-add" id="btnAcaoMain" onclick="adicionar()">Registrar Entrada</button>
            </div>
        </div>

        <div class="filters-bar">
            <input type="text" id="fLote" placeholder="Lote" onkeyup="irParaPagina(1)">
            <select id="fSku" onchange="irParaPagina(1)">
                <option value="TODOS">Filtrar SKU</option>
                <option value="200 ML">200 ML</option><option value="300 ML">300 ML</option>
                <option value="900 ML">900 ML</option><option value="1.5 LT">1.5 LT</option>
                <option value="3 LT">3 LT</option><option value="5 LT">5 LT</option>
            </select>
            <select id="fSabor" onchange="irParaPagina(1)"><option value="TODOS">Filtrar Sabor</option></select>
            <select id="fTipo" onchange="irParaPagina(1)">
                <option value="TODOS">Filtrar Tipos</option>
                <option value="Rep. Linha">Rep. Linha</option>
                <option value="Prod. Acabado">Prod. Acabado</option>
            </select>
            <select id="fStatus" onchange="irParaPagina(1)">
                <option value="TODOS">Filtrar Status</option>
                <option value="Pendente">Pendente</option>
                <option value="Reprocessado">Reprocessado</option>
                <option value="Descartado">Descartado</option>
            </select>
            <input type="text" id="fDataGeral" placeholder="Filtrar Data (DD/MM/AAAA)" onkeyup="irParaPagina(1)">
        </div>

        <div style="flex-grow: 1; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 10%;">Lote</th>
                        <th style="width: 10%;">SKU</th>
                        <th style="width: 12%;">Sabor</th>
                        <th style="width: 7%;">Qtd</th>
                        <th style="width: 10%;">Tipo</th>
                        <th style="width: 12%;">Entrada</th>
                        <th style="width: 12%;">Validade</th>
                        <th style="width: 12%;">Status</th>
                        <th style="width: 15%;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn-page" id="btnPrev" onclick="mudarPagina(-1)">Anterior</button>
            <span id="pageInfo" style="font-weight: bold;">P√°gina 1 de 1</span>
            <button class="btn-page" id="btnNext" onclick="mudarPagina(1)">Pr√≥xima</button>
        </div>
    </div>

<script>
    const STORAGE_KEY = 'controle-de-reprocesso-nfc-prats';
    let reprocessos = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let editandoId = null;
    let paginaAtual = 1;
    const itensPorPagina = 12;

    const coresSabores = {
        "Laranja": "sabor-laranja", "Fruitz Laranja": "sabor-fruitz-laranja",
        "Uva": "sabor-uva", "Fruitz Uva": "sabor-fruitz-uva",
        "Acerola": "sabor-acerola", "Goiaba": "sabor-goiaba",
        "Lim√£o": "sabor-limao", "Caju": "sabor-caju"
    };

    function adicionar() {
        const dados = {
            lote: document.getElementById('lote').value,
            sku: document.getElementById('sku').value,
            sabor: document.getElementById('sabor').value,
            qtd: document.getElementById('qtd').value,
            unidade: document.getElementById('unidade').value,
            validade: document.getElementById('validade').value
        };
        
        if(!dados.lote || !dados.sku || !dados.sabor || !dados.qtd || !dados.validade) return alert("Voc√™ deve preencher todos os dados!");

        if(editandoId) {
            const idx = reprocessos.findIndex(i => i.id === editandoId);
            reprocessos[idx] = { ...reprocessos[idx], ...dados };
            editandoId = null;
            document.getElementById('btnAcaoMain').innerText = "Registrar Entrada";
            document.getElementById('btnAcaoMain').style.background = "#27ae60";
        } else {
            reprocessos.unshift({ 
                id: Date.now(), 
                ...dados, 
                status: "Pendente",
                dataEntrada: new Date().toLocaleDateString('pt-BR') 
            });
        }
        salvar();
        limparCampos();
    }

    function editar(id) {
        const item = reprocessos.find(i => i.id === id);
        document.getElementById('lote').value = item.lote;
        document.getElementById('sku').value = item.sku;
        document.getElementById('sabor').value = item.sabor;
        document.getElementById('qtd').value = item.qtd;
        document.getElementById('unidade').value = item.unidade;
        document.getElementById('validade').value = item.validade;
        editandoId = id;
        document.getElementById('btnAcaoMain').innerText = "Salvar Altera√ß√£o";
        document.getElementById('btnAcaoMain').style.background = "#2980b9";
    }

    function alternarStatus(id) {
        const idx = reprocessos.findIndex(i => i.id === id);
        const atual = reprocessos[idx].status;
        if(atual === "Pendente") reprocessos[idx].status = "Reprocessado";
        else if(atual === "Reprocessado") reprocessos[idx].status = "Descartado";
        else reprocessos[idx].status = "Pendente";
        salvar();
    }

    function excluir(id) {
        if(confirm("Deseja excluir permanentemente?")) {
            reprocessos = reprocessos.filter(i => i.id !== id);
            salvar();
        }
    }

    function salvar() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(reprocessos)); 
        renderizar(); 
    }

    function limparCampos() { ['lote','sku','sabor','qtd','validade'].forEach(id => document.getElementById(id).value = ""); }

    function obterDadosFiltrados() {
        const fLote = document.getElementById('fLote').value.toLowerCase();
        const fSku = document.getElementById('fSku').value;
        const fSabor = document.getElementById('fSabor').value;
        const fTipo = document.getElementById('fTipo').value;
        const fStatus = document.getElementById('fStatus').value;
        const fData = document.getElementById('fDataGeral').value.toLowerCase();
        
        return reprocessos.filter(i => {
            const valFmt = i.validade.split('-').reverse().join('/');
            const matchLote = i.lote.toLowerCase().includes(fLote);
            const matchSku = (fSku === "TODOS" || i.sku === fSku);
            const matchSabor = (fSabor === "TODOS" || i.sabor === fSabor);
            const matchTipo = (fTipo === "TODOS" || i.unidade === fTipo);
            const matchStatus = (fStatus === "TODOS" || i.status === fStatus);
            const matchData = fData === "" || i.dataEntrada.includes(fData) || valFmt.includes(fData);
            
            return matchLote && matchSku && matchSabor && matchTipo && matchStatus && matchData;
        });
    }

    function renderizar() {
        const corpo = document.getElementById('tabelaCorpo');
        const filtrados = obterDadosFiltrados();

        const totalP = Math.ceil(filtrados.length / itensPorPagina) || 1;
        if(paginaAtual > totalP) paginaAtual = totalP;

        document.getElementById('pageInfo').innerText = `P√°gina ${paginaAtual} de ${totalP}`;
        document.getElementById('btnPrev').disabled = paginaAtual === 1;
        document.getElementById('btnNext').disabled = paginaAtual === totalP;
        
        const inicio = (paginaAtual - 1) * itensPorPagina;
        corpo.innerHTML = "";
        
        filtrados.slice(inicio, inicio + itensPorPagina).forEach(i => {
            const valFmt = i.validade.split('-').reverse().join('/');
            corpo.innerHTML += `<tr class="${coresSabores[i.sabor] || ''}">
                <td>${i.lote}</td><td>${i.sku}</td><td>${i.sabor}</td><td>${i.qtd}</td><td>${i.unidade}</td><td>${i.dataEntrada}</td><td>${valFmt}</td>
                <td><span class="status-${i.status.toLowerCase()}">${i.status}</span></td>
                <td>
                    <button class="btn-tabela" onclick="editar(${i.id})">Editar</button>
                    <button class="btn-tabela" onclick="alternarStatus(${i.id})">Status</button>
                    <button class="btn-tabela btn-excluir" onclick="excluir(${i.id})">X</button>
                </td></tr>`;
        });
    }

    function mudarPagina(d) { paginaAtual += d; renderizar(); }
    function irParaPagina(p) { paginaAtual = p; renderizar(); }

    function exportarJSON() {
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(reprocessos));
        const a = document.createElement('a'); a.href = s; a.download = "backup-de-seguranca-reprocessos-nfc.json"; a.click();
    }

    function importarJSON(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let data = JSON.parse(e.target.result);
                reprocessos = [...reprocessos, ...data];
                salvar();
            } catch (err) { alert("Erro ao importar."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const agora = new Date();
        const dataHoraGera = agora.toLocaleString('pt-BR');

        const filtrados = obterDadosFiltrados();

        const colunas = ["Lote", "SKU", "Sabor", "Qtd", "Tipo", "Entrada", "Validade", "Status"];
        const linhas = filtrados.map(i => [
            i.lote, i.sku, i.sabor, i.qtd, i.unidade, i.dataEntrada, i.validade.split('-').reverse().join('/'), i.status
        ]);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("Relat√≥rio de Reprocessos - C√¢mara Fria", 40, 40);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Gerado em: ${dataHoraGera}`, 40, 55);
        doc.text(`Resultados exibidos: ${filtrados.length}`, 40, 68);

        doc.autoTable({
            head: [colunas], body: linhas, startY: 80, theme: 'grid',
            headStyles: { fillStyle: [44, 62, 80], fontSize: 9, fontStyle: 'bold' }, styles: { fontSize: 8 }
        });
        doc.save(`relatorio_filtrado_nfc_${agora.getTime()}.pdf`);
    }

    const sel = document.getElementById('fSabor');
    Object.keys(coresSabores).forEach(s => {
        const o = document.createElement('option'); o.value = s; o.innerText = s;
        sel.appendChild(o);
    });

    renderizar();
</script>
</body>
</html>